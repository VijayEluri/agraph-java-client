<project name="agraph-java-client" default="clean-build">

    <property environment="env"/>
    <!-- if these AGRAPH env vars are blank, the java test code will look elsewhere -->
    <property name="env.AGRAPH_HOST" value=""/>
    <property name="env.AGRAPH_PORT" value=""/>
    
    <!-- Library. -->
    <property name="src" location="src"/>
    <property name="lib" location="lib"/>
    <property name="build" location="classes"/>
    <property name="jarfile" location="agraph.jar"/>
    
    <path id="classpath">
        <path location="${lib}/commons-codec-1.3.jar"/>
        <path location="${lib}/commons-httpclient-3.1.jar"/>
        <path location="${lib}/commons-logging-1.1.1.jar"/>
        <path location="${lib}/openrdf-sesame-2.2.4-onejar.jar"/>
        <path location="${lib}/slf4j-api-1.5.8.jar"/>
        <path location="${lib}/slf4j-nop-1.5.8.jar"/>
        <path location="${lib}/jena-2.6.0/arq-extra.jar"/>
        <path location="${lib}/jena-2.6.0/arq.jar"/>
        <path location="${lib}/jena-2.6.0/icu4j_3_4.jar"/>
        <path location="${lib}/jena-2.6.0/iri.jar"/>
        <path location="${lib}/jena-2.6.0/jena.jar"/>
        <path location="${lib}/jena-2.6.0/jenatest.jar"/>
        <path location="${lib}/jena-2.6.0/json.jar"/>
        <path location="${lib}/jena-2.6.0/junit-4.5.jar"/>
        <path location="${lib}/jena-2.6.0/log4j-1.2.12.jar"/>
        <path location="${lib}/jena-2.6.0/lucene-core-2.3.1.jar"/>
        <path location="${lib}/jena-2.6.0/stax-api-1.0.jar"/>
        <path location="${lib}/jena-2.6.0/wstx-asl-3.0.0.jar"/>
        <path location="${lib}/jena-2.6.0/xercesImpl.jar"/>
    </path>
    
    <target name="init">
        <tstamp/>
        <mkdir dir="${build}"/>
    </target>
    
    <target name="clean"
            description="Remove generated files and directories.">
        <delete dir="${build}"/>
        <delete file="${jarfile}"/>
    </target>

    <target name="compile" depends="init"
            description="Compile Java sources.">
        <javac srcdir="${src}" destdir="${build}" encoding="utf8"
               debug="true"
               includes="com/franz/agraph/repository/*.java
                         tutorial/TutorialExamples.java
                        tutorial/JenaTutorialExamples.java
                         *.java
                         test/*.java"
               classpathref="classpath"/>
    </target>
    
    <manifestclasspath property="mf.path" jarfile="${jarfile}">
        <classpath refid="classpath"/>
    </manifestclasspath>
    
    <target name="build"
            description="Create jar file."
            depends="clean, compile">
        <jar jarfile="${jarfile}">
            <fileset dir="${build}" includes="**/*.class">
                <exclude name="tutorial/**"/>
                <exclude name="test/**"/>
                <exclude name="*.class"/>
            </fileset>
            <manifest>
                <attribute name="Class-Path" value="${mf.path}"/>
            </manifest>
        </jar>
    </target>
    
    <target name="clean-build" depends="clean, build"
            description="clean, and build jar">
    </target>
    
    <target name="prepush"
            description="Tests required before git push: clean, build, and run Java and Clojure client tests"
            depends="clean-build">
        <ant dir="clojure" target="prepush" inheritall="false"/>
    </target>
    
    <macrodef name="run-java"
              description="Run java class">
        <attribute name="tasknamex" default="java"/>
        <attribute name="classname"/>
        <attribute name="arg"/>
        <sequential>
            <java classname="@{classname}" failonerror="true" taskname="@{tasknamex}"
                  fork="true">
                <sysproperty key="org.apache.commons.logging.Log"
                             value="org.apache.commons.logging.impl.NoOpLog"/>
                <sysproperty key="AGRAPH_HOST" value="${env.AGRAPH_HOST}"/>
                <sysproperty key="AGRAPH_PORT" value="${env.AGRAPH_PORT}"/>
                <classpath>
                    <path refid="classpath"/>
                    <path location="classes"/>
                </classpath>
                <arg value="@{arg}"/>
            </java>
        </sequential>
    </macrodef>
    
    <target name="test"
            depends="compile"
            description="Run unit tests">
        <junit printsummary="no" haltonfailure="yes">
            <sysproperty key="AGRAPH_HOST" value="${env.AGRAPH_HOST}"/>
            <sysproperty key="AGRAPH_PORT" value="${env.AGRAPH_PORT}"/>
            <classpath>
                <path refid="classpath"/>
                <path location="classes"/>
                <path location="${lib}/junit-4.7.jar"/>
            </classpath>
            <formatter type="plain" usefile="no"/>
            <test name="test.TutorialTests"/>
            <!-- <batchtest fork="yes" todir="${reports.tests}"> -->
            <!--     <fileset dir="${src.tests}"> -->
            <!--         <include name="**/*Test*.java"/> -->
            <!--         <exclude name="**/AllTests.java"/> -->
            <!--     </fileset> -->
            <!-- </batchtest> -->
        </junit>
    </target>
    
    <target name="test1"
            depends="compile"
            description="test">
        <property name="test" value="1"/>
        <run-java tasknamex="test" classname="test.TutorialTests" arg="${test}"/>
    </target>
    
    <target name="test-stress"
            depends="compile"
            description="Run test.TransactionStressTest">
        <run-java tasknamex="stress" classname="test.TransactionStressTest" arg=""/>
    </target>
    
    <target name="tutorial"
            depends="compile"
            description="Run tutorial example. Use -Dexample=5 for a specific example, default is all">
        <property name="example" value="all"/>
        <run-java tasknamex="tutorial" classname="tutorial.TutorialExamples" arg="${example}"/>
    </target>
    
    <target name="jena-tutorial"
            depends="compile"
            description="Run jena examples. Use -Dexample=5 for a specific example, default is all">
        <property name="example" value="all"/>
        <run-java tasknamex="jena-tutorial" classname="tutorial.JenaTutorialExamples" arg="${example}"/>
    </target>
    
</project>
